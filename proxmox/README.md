# Structure

```
ğŸ—‚ï¸ PA/
â”œâ”€ ğŸ—‚ï¸ ansible/
â”‚ â”œâ”€ ğŸ—‚ï¸ inventory/
â”‚ â”‚ â”œâ”€ ğŸ“ƒ hosts.ini            # output file from .generate_inventory.sh contains VMs IP used by ansible to know which VMs to work on
â”‚ â”‚ â”œâ”€ ğŸ“ƒ inventory.json       # output file from terraform output -json k3s_hosts > inventory.json
â”‚ â”œâ”€ ğŸ—‚ï¸ roles/
â”‚ â”‚ â”œâ”€ ğŸ—‚ï¸ k3s/
â”‚ â”‚ â”‚ â”œâ”€ ğŸ—‚ï¸ files/
â”‚ â”‚ â”‚ â”‚ â”œâ”€ âš™ï¸ join_node.sh
â”‚ â”‚ â”‚ â”‚ â”œâ”€ âš™ï¸ k3s_install.sh
â”‚ â”‚ â”‚ â”œâ”€ ğŸ—‚ï¸ tasks/
â”‚ â”‚ â”‚ â”‚ â”œâ”€ âš™ï¸ main.yml         # rien pour l'instant
â”‚ â”œâ”€ âš™ï¸ ansible.cfg           # calls terraform.yml
â”‚ â”œâ”€ âš™ï¸ playbook.yml           # main playbook
|
â”œâ”€ ğŸ—‚ï¸ terraform/
â”‚ â”œâ”€ ğŸ—‚ï¸ modules/
â”‚ â”‚ â”œâ”€ ğŸ—‚ï¸ k3s_vm/
â”‚ â”‚ â”‚ â”œâ”€ âš™ï¸ main.tf            # main config for the k3s_vm module
â”‚ â”œâ”€ âš™ï¸ main.tf                # main config
â”‚ â”œâ”€ ğŸ“„ output.tf              # script to printf data in output that will be then used in ansible
â”‚ â”œâ”€ ğŸ“„ provider.tf            # terraform provider to interact with proxmox
â”‚ â”œâ”€ ğŸ“„ terraform.tfvars       # variables globales
â”‚ â”œâ”€ âš™ï¸ get_next_vmid.sh       # script to get the latest VM/LXC ID available
â”‚ â”œâ”€ âš™ï¸ generate_inventory.sh  # script to generate ansible/inventory/inventory/hosts.ini
| |
| |  # Automatically generated files
â”‚ â”œâ”€ ğŸ“ƒ tf.plan                # output file from terraform plan -out=./tf.plan
â”‚ â”œâ”€ ğŸ“ƒ terraform.tfstate      # ouput file automatically generated by terraform
```

Se connecter au Proxmox via Tailscale

- Par ssh : `cd PA`
- Par GUI : aller sur le node 'proxmox', puis aller dans l'onget `Shell`, puis `cd /root/PA`

# Terraform

## Instructions

```bash
cd terraform
terraform init # init
terraform plan -out=./tf.plan # utilise la config dans un fichier tf.plan
terraform apply -auto-approve tf.plan # applique la config pour crÃ©er les vm et tout
./generate_inventory.sh # lance un script pour gÃ©nÃ©rer un fichier hosts.ini avec des datas Ã  feed comme les IPs des VM crÃ©Ã©es Ansible
```

# Ansible

## Instruction

AprÃ¨s la crÃ©ationde VM et/ou LXC installez Git, Docker et installer une clÃ© SSH en exÃ©cutant le book suivant : 

```bash
#To run the setup on specific groups:"
#---------------------------------------"
# All hosts:
ansible-playbook -i inventory/hosts.ini setup-vms.yml --vault-password-file group_vars/all/.vault_pass.txt
# Only VMs:
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit master,worker --vault-password-file group_vars/all/.vault_pass.txt
# Only databases:
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit databases --vault-password-file group_vars/all/.vault_pass.txt
# Only master: 
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit master --vault-password-file group_vars/all/.vault_pass.txt
# Only workers: 
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit worker --vault-password-file group_vars/all/.vault_pass.txt
```

*(optionnel)* Pour installer Postgres et ElasticSearch sur des LXC, lancez la commande suivant pour installer les base de donnÃ©es :

```bash
cd ../ansible
ansible-playbook database-setup.yml --vault-password-file group_vars/all/.vault_pass.txt

# pour vÃ©rifier l'installation de Postgres
ssh root@192.168.1.142
systemctl status postgresql
sudo -u postgres psql -c 'SELECT version();'
netstat -tlnp | grep 5432
tail -20 /var/log/postgresql/postgresql-16-main.log

# pour vÃ©rifier l'installation de ElasticSearch
ssh root@192.168.1.144
systemctl status elasticsearch
# version et cluster health
curl -X GET 'localhost:9200/_cluster/health?pretty'
# vÃ©rification du port
netstat -tlnp | grep 9200
# logs
tail -20 /var/log/elasticsearch/queryforge-cluster.log
```

*(optionnel)* Pour installer k3s dans les VMs, lancez la commande suivant pour installer k3s dans les VMs en fonction du role de la VM :

```bash
cd ../ansible
ansible-playbook playbook.yml --vault-password-file group_vars/all/.vault_pass.txt
```
## Vault

```bash
ansible-vault encrypt group_vars/all/vault.yml
ansible-vault edit group_vars/all/vault.yml
```
# Cleanup

```bash
# pour supprimer les VM crÃ©Ã©es, mais autant utiliser le GUI si vous voulez supprimer les VMs
terraform destroy

rm terraform/terraform.tfstate*
rm tf.plan
rm -rf .terraform .terraform.lock.hcl
```

# Kubernetes

## Commands

```bash
# list nodes
kubectl get ndoes -o wide

# afficher des informations plus dÃ©taillÃ©es sur un noeud
kubectl describe node <node_name>




# Proxmox

## Commands

```bash
#monter les VMs 
qm list
qm config <VM_ID>
mkdir -p /mnt/vm<VM_ID>
guestmount -a /var/lib/vz/images/<VM_ID>/vm-<VM_ID>-disk-1.raw -i /mnt/vm<VM_ID>
```
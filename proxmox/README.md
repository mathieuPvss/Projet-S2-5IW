# Structure

```
🗂️ PA/
├─ 🗂️ ansible/
│ ├─ 🗂️ inventory/
│ │ ├─ 📃 hosts.ini            # output file from .generate_inventory.sh contains VMs IP used by ansible to know which VMs to work on
│ │ ├─ 📃 inventory.json       # output file from terraform output -json k3s_hosts > inventory.json
│ ├─ 🗂️ roles/
│ │ ├─ 🗂️ k3s/
│ │ │ ├─ 🗂️ files/
│ │ │ │ ├─ ⚙️ join_node.sh
│ │ │ │ ├─ ⚙️ k3s_install.sh
│ │ │ ├─ 🗂️ tasks/
│ │ │ │ ├─ ⚙️ main.yml         # rien pour l'instant
│ ├─ ⚙️ ansible.cfg           # calls terraform.yml
│ ├─ ⚙️ playbook.yml           # main playbook
|
├─ 🗂️ terraform/
│ ├─ 🗂️ modules/
│ │ ├─ 🗂️ k3s_vm/
│ │ │ ├─ ⚙️ main.tf            # main config for the k3s_vm module
│ ├─ ⚙️ main.tf                # main config
│ ├─ 📄 output.tf              # script to printf data in output that will be then used in ansible
│ ├─ 📄 provider.tf            # terraform provider to interact with proxmox
│ ├─ 📄 terraform.tfvars       # variables globales
│ ├─ ⚙️ get_next_vmid.sh       # script to get the latest VM/LXC ID available
│ ├─ ⚙️ generate_inventory.sh  # script to generate ansible/inventory/inventory/hosts.ini
| |
| |  # Automatically generated files
│ ├─ 📃 tf.plan                # output file from terraform plan -out=./tf.plan
│ ├─ 📃 terraform.tfstate      # ouput file automatically generated by terraform
```

Se connecter au Proxmox via Tailscale

- Par ssh : `cd PA`
- Par GUI : aller sur le node 'proxmox', puis aller dans l'onget `Shell`, puis `cd /root/PA`

# Terraform

## Instructions

```bash
cd terraform
terraform init # init
terraform plan -out=./tf.plan # utilise la config dans un fichier tf.plan
terraform apply -auto-approve tf.plan # applique la config pour créer les vm et tout
./generate_inventory.sh # lance un script pour générer un fichier hosts.ini avec des datas à feed comme les IPs des VM créées Ansible
```

# Ansible

## Instruction

Après la créationde VM et/ou LXC installez Git, Docker et installer une clé SSH en exécutant le book suivant : 

```bash
#To run the setup on specific groups:"
#---------------------------------------"
# All hosts:
ansible-playbook -i inventory/hosts.ini setup-vms.yml --vault-password-file group_vars/all/.vault_pass.txt
# Only VMs:
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit master,worker --vault-password-file group_vars/all/.vault_pass.txt
# Only databases:
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit databases --vault-password-file group_vars/all/.vault_pass.txt
# Only master: 
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit master --vault-password-file group_vars/all/.vault_pass.txt
# Only workers: 
ansible-playbook -i inventory/hosts.ini setup-vms.yml --limit worker --vault-password-file group_vars/all/.vault_pass.txt
```

*(optionnel)* Pour installer Postgres et ElasticSearch sur des LXC, lancez la commande suivant pour installer les base de données :

```bash
cd ../ansible
ansible-playbook database-setup.yml --vault-password-file group_vars/all/.vault_pass.txt

# pour vérifier l'installation de Postgres
ssh root@192.168.1.142
systemctl status postgresql
sudo -u postgres psql -c 'SELECT version();'
netstat -tlnp | grep 5432
tail -20 /var/log/postgresql/postgresql-16-main.log

# pour vérifier l'installation de ElasticSearch
ssh root@192.168.1.144
systemctl status elasticsearch
# version et cluster health
curl -X GET 'localhost:9200/_cluster/health?pretty'
# vérification du port
netstat -tlnp | grep 9200
# logs
tail -20 /var/log/elasticsearch/queryforge-cluster.log
```

*(optionnel)* Pour installer k3s dans les VMs, lancez la commande suivant pour installer k3s dans les VMs en fonction du role de la VM :

```bash
cd ../ansible
ansible-playbook playbook.yml --vault-password-file group_vars/all/.vault_pass.txt
```
## Vault

```bash
ansible-vault encrypt group_vars/all/vault.yml
ansible-vault edit group_vars/all/vault.yml
```
# Cleanup

```bash
# pour supprimer les VM créées, mais autant utiliser le GUI si vous voulez supprimer les VMs
terraform destroy

rm terraform/terraform.tfstate*
rm tf.plan
rm -rf .terraform .terraform.lock.hcl
```

# Kubernetes

## Commands

```bash
# list nodes
kubectl get ndoes -o wide

# afficher des informations plus détaillées sur un noeud
kubectl describe node <node_name>




# Proxmox

## Commands

```bash
#monter les VMs 
qm list
qm config <VM_ID>
mkdir -p /mnt/vm<VM_ID>
guestmount -a /var/lib/vz/images/<VM_ID>/vm-<VM_ID>-disk-1.raw -i /mnt/vm<VM_ID>
```